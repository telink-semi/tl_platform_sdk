/********************************************************************************************************
 * @file    hal_es8389.c
 *
 * @brief   This is the source file for TL7518/TL721X/TL321X
 *
 * @author  Driver Group
 * @date    2024
 *
 * @par     Copyright (c) 2024, Telink Semiconductor (Shanghai) Co., Ltd. ("TELINK")
 *
 *          Licensed under the Apache License, Version 2.0 (the "License");
 *          you may not use this file except in compliance with the License.
 *          You may obtain a copy of the License at
 *
 *              http://www.apache.org/licenses/LICENSE-2.0
 *
 *          Unless required by applicable law or agreed to in writing, software
 *          distributed under the License is distributed on an "AS IS" BASIS,
 *          WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *          See the License for the specific language governing permissions and
 *          limitations under the License.
 *
 *******************************************************************************************************/
#include "hal_es8389.h" //2.0.0.3.0511

#if (AUDIO_I2S_TO_EXT_MODE == I2S_TO_EXT_es8389)
struct _coeff_div
{
    uint16_t Ratio;
    uint32_t MCLK;
    uint32_t LRCK;
    uint8_t  Reg0x04;
    uint8_t  Reg0x05;
    uint8_t  Reg0x06;
    uint8_t  Reg0x07;
    uint8_t  Reg0x08;
    uint8_t  Reg0x09;
    uint8_t  Reg0x0A;
    uint8_t  Reg0x0F;
    uint8_t  Reg0x11;
    uint8_t  Reg0x21;
    uint8_t  Reg0x22;
    uint8_t  Reg0x26;
    uint8_t  Reg0x2F;
    uint8_t  Reg0x30;
    uint8_t  Reg0x41;
    uint8_t  Reg0x42;
    uint8_t  Reg0x43;
    uint8_t  Reg0x44;
    uint8_t  Reg0xF0;
};

static inline int get_coeff(uint32_t mclk, uint32_t rate, int array, const struct _coeff_div *coeff_div);
static void       Everest_probe(void);
// static void Everest_set_dai_fmt(uint8_t);
static uint8_t Everest_set_dai_sysclk(uint32_t rate, uint32_t mclk);
// static void Everest_pcm_hw_params(uint8_t params);
// static void Everest_set_bias_standby(void);
static void Everest_set_bias_on(void);
// static void Everest_set_bias_off(void);
// static void Everest_pcm_hw_params(uint8_t width);

static const Alsa_Device Everest = {
    I2C_ES8389_ADD,
};


static const struct _coeff_div coeff_div[] = {
    //    Ratio    Freq MCLK    FreqLRCK,0x04    ,0x05    ,0x06    ,0x07    ,0x08    ,0x09    ,0x0A    ,0x0F    ,0x11    ,0x21    ,0x22    ,0x26    ,0x2F    ,0x30    ,0x41    ,0x42    ,0x43    ,0x44    ,0xF0
    {32, 256000, 8000, 0x00, 0x57, 0x84, 0xD0, 0x03, 0xC1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {36, 288000, 8000, 0x00, 0x55, 0x84, 0xD0, 0x01, 0xC1, 0x90, 0x00, 0x00, 0x23, 0x8F, 0xBF, 0xC8, 0xC0, 0x1F, 0x8F, 0x01, 0x80, 0x11},
    {48, 384000, 8000, 0x02, 0x5F, 0x04, 0xC0, 0x03, 0xC1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {50, 400000, 8000, 0x00, 0x15, 0x85, 0xD0, 0x01, 0xC1, 0x90, 0x00, 0x00, 0x31, 0xC7, 0xC5, 0xC8, 0x00, 0x8F, 0xC7, 0x01, 0x80, 0x11},
    {64, 512000, 8000, 0x00, 0x4D, 0x24, 0xC0, 0x03, 0xD1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {72, 576000, 8000, 0x00, 0x45, 0x24, 0xC0, 0x01, 0xD1, 0x90, 0x00, 0x00, 0x23, 0x8F, 0xBF, 0xC8, 0xC0, 0x1F, 0x8F, 0x01, 0x80, 0x11},
    {96, 768000, 8000, 0x02, 0x57, 0x84, 0xD0, 0x03, 0xC1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {128, 1024000, 8000, 0x00, 0x45, 0x04, 0xD0, 0x03, 0xC1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {192, 1536000, 8000, 0x02, 0x4D, 0x24, 0xC0, 0x03, 0xD1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {256, 2048000, 8000, 0x01, 0x45, 0x04, 0xD0, 0x03, 0xC1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {288, 2304000, 8000, 0x01, 0x51, 0x00, 0xC0, 0x01, 0xC1, 0x90, 0x00, 0x00, 0x23, 0x8F, 0xBF, 0xC8, 0xC0, 0x1F, 0x8F, 0x01, 0x80, 0x11},
    {384, 3072000, 8000, 0x02, 0x45, 0x04, 0xD0, 0x03, 0xC1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {512, 4096000, 8000, 0x00, 0x41, 0x04, 0xE0, 0x00, 0xD1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {600, 4800000, 8000, 0x02, 0x24, 0x05, 0xD0, 0x00, 0xC2, 0x80, 0x00, 0x00, 0x31, 0xC7, 0xC5, 0xC8, 0x00, 0x8F, 0xC7, 0x01, 0x80, 0x11},
    {768, 6144000, 8000, 0x05, 0x45, 0x04, 0xD0, 0x03, 0xC1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {1024, 8192000, 8000, 0x01, 0x41, 0x06, 0xE0, 0x00, 0xD1, 0xB0, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {1500, 12000000, 8000, 0x0E, 0x25, 0x25, 0xE8, 0x00, 0xD1, 0x90, 0x40, 0x00, 0x31, 0xC7, 0xC5, 0xC8, 0x00, 0x8F, 0xC7, 0x01, 0x80, 0x11},
    {1536, 12288000, 8000, 0x02, 0x41, 0x04, 0xE0, 0x00, 0xD1, 0xB0, 0x40, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {1625, 13000000, 8000, 0x40, 0x6E, 0x05, 0xC8, 0x01, 0xC2, 0x90, 0x40, 0x00, 0x18, 0x95, 0xD0, 0xC8, 0xC0, 0x63, 0x95, 0x00, 0x80, 0x11},
    {2048, 16384000, 8000, 0x03, 0x44, 0x01, 0xC0, 0x00, 0xD2, 0x80, 0x40, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {2304, 18432000, 8000, 0x11, 0x45, 0x25, 0xF0, 0x00, 0xD1, 0xB0, 0x40, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {2400, 19200000, 8000, 0x05, 0x14, 0x01, 0xC9, 0x00, 0xD2, 0x80, 0x80, 0x00, 0x31, 0xC7, 0xC5, 0xC8, 0x00, 0x8F, 0xC7, 0x01, 0x80, 0x11},
    {3000, 24000000, 8000, 0x0E, 0x24, 0x05, 0xD0, 0x00, 0xC2, 0x80, 0xC0, 0x00, 0x31, 0xC7, 0xC5, 0xC8, 0x00, 0x8F, 0xC7, 0x01, 0x80, 0x11},
    {3072, 24576000, 8000, 0x05, 0x44, 0x01, 0xC0, 0x00, 0xD2, 0x80, 0x40, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x01, 0x80, 0x11},
    {3250, 26000000, 8000, 0x40, 0x15, 0x85, 0xD0, 0x01, 0xC1, 0x90, 0xC0, 0x00, 0x31, 0xC7, 0xC5, 0xC8, 0x00, 0x8F, 0xC7, 0x01, 0x80, 0x11},
    {32, 512000, 16000, 0x00, 0x55, 0x84, 0xD0, 0x01, 0xC1, 0x90, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {36, 576000, 16000, 0x00, 0x55, 0x84, 0xD0, 0x01, 0xC1, 0x90, 0x00, 0x00, 0x23, 0x8F, 0xBF, 0xC8, 0xC0, 0x1F, 0x8F, 0x01, 0x80, 0x11},
    {48, 768000, 16000, 0x02, 0x57, 0x04, 0xC0, 0x01, 0xC1, 0x90, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {50, 800000, 16000, 0x00, 0x7E, 0x01, 0xD9, 0x00, 0xC2, 0x80, 0x00, 0x00, 0x18, 0x95, 0xD0, 0xC8, 0xC0, 0xC7, 0x95, 0x00, 0x80, 0x11},
    {64, 1024000, 16000, 0x00, 0x45, 0x24, 0xC0, 0x01, 0xD1, 0x90, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {72, 1152000, 16000, 0x00, 0x45, 0x24, 0xC0, 0x01, 0xD1, 0x90, 0x00, 0x00, 0x23, 0x8F, 0xBF, 0xC8, 0xC0, 0x1F, 0x8F, 0x01, 0x80, 0x11},
    {96, 1536000, 16000, 0x02, 0x55, 0x84, 0xD0, 0x01, 0xC1, 0x90, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {128, 2048000, 16000, 0x00, 0x51, 0x04, 0xD0, 0x01, 0xC1, 0x90, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {144, 2304000, 16000, 0x00, 0x51, 0x00, 0xC0, 0x01, 0xC1, 0x90, 0x00, 0x00, 0x23, 0x8F, 0xBF, 0xC8, 0xC0, 0x1F, 0x8F, 0x01, 0x80, 0x11},
    {192, 3072000, 16000, 0x02, 0x65, 0x25, 0xE0, 0x00, 0xE1, 0x90, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {256, 4096000, 16000, 0x00, 0x41, 0x04, 0xC0, 0x01, 0xD1, 0x90, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {300, 4800000, 16000, 0x02, 0x66, 0x01, 0xD9, 0x00, 0xC2, 0x80, 0x00, 0x00, 0x18, 0x95, 0xD0, 0xC8, 0xC0, 0xC7, 0x95, 0x00, 0x80, 0x11},
    {384, 6144000, 16000, 0x02, 0x51, 0x04, 0xD0, 0x01, 0xC1, 0x90, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {512, 8192000, 16000, 0x01, 0x41, 0x04, 0xC0, 0x01, 0xD1, 0x90, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {750, 12000000, 16000, 0x0E, 0x7E, 0x01, 0xC9, 0x00, 0xC2, 0x80, 0x40, 0x00, 0x18, 0x95, 0xD0, 0xC8, 0xC0, 0xC7, 0x95, 0x00, 0x80, 0x11},
    {768, 12288000, 16000, 0x02, 0x41, 0x04, 0xC0, 0x01, 0xD1, 0x90, 0x40, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {1024, 16384000, 16000, 0x03, 0x41, 0x04, 0xC0, 0x01, 0xD1, 0x90, 0x40, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {1152, 18432000, 16000, 0x08, 0x51, 0x04, 0xD0, 0x01, 0xC1, 0x90, 0x40, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {1200, 19200000, 16000, 0x0B, 0x66, 0x01, 0xD9, 0x00, 0xC2, 0x80, 0x40, 0x00, 0x18, 0x95, 0xD0, 0xC8, 0xC0, 0xC7, 0x95, 0x00, 0x80, 0x11},
    {1500, 24000000, 16000, 0x0E, 0x26, 0x01, 0xD9, 0x00, 0xC2, 0x80, 0xC0, 0x00, 0x18, 0x95, 0xD0, 0xC8, 0xC0, 0xC7, 0x95, 0x00, 0x80, 0x11},
    {1536, 24576000, 16000, 0x05, 0x41, 0x04, 0xC0, 0x01, 0xD1, 0x90, 0xC0, 0x00, 0x1F, 0x7F, 0xBF, 0xC8, 0xC0, 0xFF, 0x7F, 0x00, 0x80, 0x11},
    {1625, 26000000, 16000, 0x40, 0x6E, 0x05, 0xC8, 0x01, 0xC2, 0x90, 0xC0, 0x00, 0x18, 0x95, 0xD0, 0xC8, 0xC0, 0x63, 0x95, 0x00, 0x80, 0x11},
    {800, 19200000, 24000, 0x07, 0x66, 0x01, 0xD9, 0x00, 0xC2, 0x80, 0x40, 0x00, 0x18, 0x95, 0xD0, 0xC8, 0xC0, 0xC7, 0x95, 0x00, 0x80, 0x11},
    {600, 19200000, 32000, 0x05, 0x46, 0x01, 0xD8, 0x10, 0xD2, 0x80, 0x40, 0x00, 0x18, 0x95, 0xD0, 0xC0, 0xC0, 0x63, 0x95, 0x00, 0x00, 0x11},
    {32, 1411200, 44100, 0x00, 0x45, 0xA4, 0xD0, 0x10, 0xD1, 0x80, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {64, 2822400, 44100, 0x00, 0x51, 0x00, 0xC0, 0x10, 0xC1, 0x80, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {128, 5644800, 44100, 0x00, 0x41, 0x04, 0xD0, 0x10, 0xD1, 0x80, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {256, 11289600, 44100, 0x01, 0x41, 0x04, 0xD0, 0x10, 0xD1, 0x80, 0x40, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {512, 22579200, 44100, 0x03, 0x41, 0x04, 0xD0, 0x10, 0xD1, 0x80, 0xC0, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {32, 1536000, 48000, 0x00, 0x45, 0xA4, 0xD0, 0x10, 0xD1, 0x80, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {48, 2304000, 48000, 0x02, 0x55, 0x04, 0xC0, 0x10, 0xC1, 0x80, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {50, 2400000, 48000, 0x00, 0x76, 0x01, 0xC8, 0x10, 0xC2, 0x80, 0x00, 0x00, 0x18, 0x95, 0xD0, 0xC0, 0xC0, 0x63, 0x95, 0x00, 0x00, 0x11},
    {64, 3072000, 48000, 0x00, 0x51, 0x04, 0xC0, 0x10, 0xC1, 0x80, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {100, 4800000, 48000, 0x00, 0x46, 0x01, 0xD8, 0x10, 0xD2, 0x80, 0x00, 0x00, 0x18, 0x95, 0xD0, 0xC0, 0xC0, 0x63, 0x95, 0x00, 0x00, 0x11},
    {125, 6000000, 48000, 0x04, 0x6E, 0x05, 0xC8, 0x10, 0xC2, 0x80, 0x00, 0x01, 0x18, 0x95, 0xD0, 0xC0, 0xC0, 0x63, 0x95, 0x00, 0x00, 0x11},
    {128, 6144000, 48000, 0x00, 0x41, 0x04, 0xD0, 0x10, 0xD1, 0x80, 0x00, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {200, 9600000, 48000, 0x01, 0x46, 0x01, 0xD8, 0x10, 0xD2, 0x80, 0x00, 0x00, 0x18, 0x95, 0xD0, 0xC0, 0xC0, 0x63, 0x95, 0x00, 0x00, 0x11},
    {250, 12000000, 48000, 0x04, 0x76, 0x01, 0xC8, 0x10, 0xC2, 0x80, 0x40, 0x00, 0x18, 0x95, 0xD0, 0xC0, 0xC0, 0x63, 0x95, 0x00, 0x00, 0x11},
    {256, 12288000, 48000, 0x01, 0x41, 0x04, 0xD0, 0x10, 0xD1, 0x80, 0x40, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {384, 18432000, 48000, 0x02, 0x41, 0x04, 0xD0, 0x10, 0xD1, 0x80, 0x40, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {400, 19200000, 48000, 0x03, 0x46, 0x01, 0xD8, 0x10, 0xD2, 0x80, 0x40, 0x00, 0x18, 0x95, 0xD0, 0xC0, 0xC0, 0x63, 0x95, 0x00, 0x00, 0x11},
    {500, 24000000, 48000, 0x04, 0x46, 0x01, 0xD8, 0x10, 0xD2, 0x80, 0xC0, 0x00, 0x18, 0x95, 0xD0, 0xC0, 0xC0, 0x63, 0x95, 0x00, 0x00, 0x11},
    {512, 24576000, 48000, 0x03, 0x41, 0x04, 0xD0, 0x10, 0xD1, 0x80, 0xC0, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {800, 38400000, 48000, 0x18, 0x45, 0x04, 0xC0, 0x10, 0xC1, 0x80, 0xC0, 0x00, 0x1F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x00, 0x00, 0x11},
    {128, 11289600, 88200, 0x00, 0x50, 0x00, 0xC0, 0x10, 0xC1, 0x80, 0x40, 0x00, 0x9F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x80, 0x00, 0x11},
    {64, 6144000, 96000, 0x00, 0x41, 0x00, 0xD0, 0x10, 0xD1, 0x80, 0x00, 0x00, 0x9F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x80, 0x00, 0x11},
    {256, 24576000, 96000, 0x00, 0x40, 0x00, 0xC0, 0x10, 0xC1, 0x80, 0xC0, 0x00, 0x9F, 0x7F, 0xBF, 0xC0, 0xC0, 0x7F, 0x7F, 0x80, 0x00, 0x11},
    {128, 24576000, 192000, 0x00, 0x50, 0x00, 0xC0, 0x18, 0xC1, 0x81, 0xC0, 0x00, 0x8F, 0x7F, 0xBF, 0xC0, 0xC0, 0x3F, 0x7F, 0x80, 0x00, 0x11},
};

static inline int get_coeff(uint32_t mclk, uint32_t rate, int array, const struct _coeff_div *coeff_div_)
{
    int i;
    for (i = 0; i < array; i++) {
        if (coeff_div_[i].Ratio == rate && coeff_div_[i].MCLK == mclk) {
            return i;
        }
    }
    return -1;
}

static void Everest_probe(void)
{
    regmap_write(Everest.regmap, Everest_Reg0xF3, 0x00);
    regmap_write(Everest.regmap, Everest_Reg0x00, 0x7E);
    regmap_write(Everest.regmap, Everest_Reg0xF3, 0x38);
    regmap_write(Everest.regmap, ES8389_Reg0x25_ADCInvert, 0x06 + (ES8389_ADC1_Invert << 6) + (ES8389_ADC2_Invert << 5));
    regmap_write(Everest.regmap, ES8389_Reg0x45_DACInvert, 0x03 + (ES8389_DAC1_Invert << 6) + (ES8389_DAC2_Invert << 5));
    regmap_write(Everest.regmap, Everest_Reg0x60, 0x2A);
    regmap_write(Everest.regmap, Everest_Reg0x61, 0xC9);
    regmap_write(Everest.regmap, Everest_Reg0x62, 0x7F);
    regmap_write(Everest.regmap, Everest_Reg0x63, 0x06);
    regmap_write(Everest.regmap, Everest_Reg0x6B, 0x00);
    regmap_write(Everest.regmap, ES8389_Reg0x6D_DMICSel, 0x28 + (ES8389_DMICSel & 0xC0));
    regmap_write(Everest.regmap, ES8389_Reg0x23_DMICSel_TDMSel, 0x00 + (ES8389_TDM_OFF & 0xC0) + (ES8389_DMIC_Invert << 2) + (ES8389_DMICSel & 0x03));
    regmap_write(Everest.regmap, ES8389_Reg0x72_ADCL_Input_PGAGain, (ES8389_ADCL_InputSel << 4) + ES8389_ADCL_PGAGainSel);
    regmap_write(Everest.regmap, ES8389_Reg0x73_ADCR_Input_PGAGain, (ES8389_ADCR_InputSel << 4) + ES8389_ADCR_PGAGainSel);
    regmap_write(Everest.regmap, Everest_Reg0x10, 0xC4);
    regmap_write(Everest.regmap, ES8389_Reg0x01_CLKTRI_MSMode, 0x08 + (ES8389_BCLK_TRI << 7) + (ES8389_LRCK_TRI << 6) + (ES8389_ASDOUT_TRI << 5) + (ES8389_MS_ModeSel << 0));
    regmap_write(Everest.regmap, Everest_Reg0xF1, 0x00);
    regmap_write(Everest.regmap, Everest_Reg0x12, 0x01);
    regmap_write(Everest.regmap, Everest_Reg0x13, 0x01);
    regmap_write(Everest.regmap, Everest_Reg0x14, 0x01);
    regmap_write(Everest.regmap, Everest_Reg0x15, 0x01);
    regmap_write(Everest.regmap, Everest_Reg0x16, 0x1F);
    regmap_write(Everest.regmap, Everest_Reg0x17, 0x09);
    regmap_write(Everest.regmap, Everest_Reg0x18, 0x91);
    regmap_write(Everest.regmap, Everest_Reg0x19, 0x28);
    regmap_write(Everest.regmap, Everest_Reg0x1A, 0x01);
    regmap_write(Everest.regmap, Everest_Reg0x1B, 0x01);
    regmap_write(Everest.regmap, Everest_Reg0x1C, 0x11);
    regmap_write(Everest.regmap, ES8389_Reg0x2A_ADCPTDM_SLOTSel, 0x00 + (ES8389_ADCPTDM_SLOTSel << 4));
    regmap_write(Everest.regmap, ES8389_Reg0x20_ADCFMT_ADCMUTE,
                 0x00 + (ES8389_DAIFMT_LE << 5) + (ES8389_LRCK_Invert << 4) + (ES8389_DAIFMT_FORMAT << 2) + (ES8389_ADC2_MUTE << 1) + (ES8389_ADC1_MUTE << 0)); //2
    regmap_write(Everest.regmap, ES8389_Reg0x40_DACFMT_DACMUTE,
                 0x00 + (ES8389_DAIFMT_LE << 5) + (ES8389_LRCK_Invert << 4) + (ES8389_DAIFMT_FORMAT << 2) + (ES8389_DAC2_MUTE << 1) + (ES8389_DAC1_MUTE << 0)); //2
    regmap_write(Everest.regmap, ES8389_Reg0xF0_LOOP, 0x11 + (ES8389_LOOP_DACToADC << 3) + (ES8389_LOOP_ADCToDAC << 2));
    regmap_write(Everest.regmap, ES8389_Reg0x02_CLKInvert, 0x00 + (ES8389_MainCLK_Source << 6) + (ES8389_MCLK_Invert << 1) + (ES8389_BCLK_Invert << 0)); //2
    regmap_write(Everest.regmap, Everest_Reg0x04, 0x00);
    regmap_write(Everest.regmap, Everest_Reg0x05, 0x10);
    regmap_write(Everest.regmap, Everest_Reg0x06, 0x00);
    regmap_write(Everest.regmap, Everest_Reg0x07, 0xC0);
    regmap_write(Everest.regmap, Everest_Reg0x08, 0x00);
    regmap_write(Everest.regmap, Everest_Reg0x09, 0xC0);
    regmap_write(Everest.regmap, Everest_Reg0x0A, 0x80);
    regmap_write(Everest.regmap, ES8389_Reg0x0B_SCLKDivide, ES8389_SCLK_Divide);
    regmap_write(Everest.regmap, ES8389_Reg0x0C_MSTFMT_LRCKDivideH, (ES8389_LRCK_Divide >> 8));
    regmap_write(Everest.regmap, ES8389_Reg0x0D_LRCKDivideL, (ES8389_LRCK_Divide & 0xFF)); //
    regmap_write(Everest.regmap, Everest_Reg0x0F, 0x10);
    regmap_write(Everest.regmap, Everest_Reg0x21, 0x1F);
    regmap_write(Everest.regmap, Everest_Reg0x22, 0x7F);
    regmap_write(Everest.regmap, Everest_Reg0x30, 0xF4); //0605
    regmap_write(Everest.regmap, ES8389_Reg0x31_ADCMix, 0x00 + (ES8389_MIX_DAC1AndADC1ToADC1 << 7) + (ES8389_MIX_DAC2AndADC2ToADC2 << 6));
    regmap_write(Everest.regmap, ES8389_Reg0x44_DACMix,
                 0x00 + (ES8389_MIX_DAC1AndDAC2ToDAC1 << 3) + (ES8389_MIX_DAC1AndDAC2ToDAC2 << 2) + (ES8389_MIX_ADC1AndDAC1ToDAC1 << 1) + (ES8389_MIX_ADC2AndDAC2ToDAC2 << 0));
    regmap_write(Everest.regmap, Everest_Reg0x41, 0x7F);
    regmap_write(Everest.regmap, Everest_Reg0x42, 0x7F);
    regmap_write(Everest.regmap, Everest_Reg0x43, 0x10);
    regmap_write(Everest.regmap, ES8389_Reg0x49_DACSTDM_SLOTSel, 0x0F + (ES8389_DACSTDM_SLOTSel << 4));
    regmap_write(Everest.regmap, Everest_Reg0x4C, 0xC0);

    regmap_write(Everest.regmap, Everest_Reg0x00, 0x00);
    regmap_write(Everest.regmap, Everest_Reg0x03, 0xC1);
    regmap_write(Everest.regmap, Everest_Reg0x00, 0x01);
    regmap_write(Everest.regmap, Everest_Reg0x4D, 0x02);
}

static uint8_t Everest_set_dai_sysclk(uint32_t rate, uint32_t mclk)
{
    int match = 0;

    match = get_coeff(mclk, rate, sizeof(coeff_div) / sizeof(struct _coeff_div), coeff_div);
    if (match >= 0) {
        regmap_write(Everest.regmap, Everest_Reg0x04, coeff_div[match].Reg0x04);
        regmap_write(Everest.regmap, Everest_Reg0x05, coeff_div[match].Reg0x05);
        regmap_write(Everest.regmap, Everest_Reg0x06, coeff_div[match].Reg0x06);
        regmap_write(Everest.regmap, Everest_Reg0x07, coeff_div[match].Reg0x07);
        regmap_write(Everest.regmap, Everest_Reg0x08, coeff_div[match].Reg0x08);
        regmap_write(Everest.regmap, Everest_Reg0x09, coeff_div[match].Reg0x09); //ï¼Ÿï¼Ÿï¼?
        regmap_write(Everest.regmap, Everest_Reg0x0A, coeff_div[match].Reg0x0A);
        regmap_update_bits(Everest.regmap, Everest_Reg0x0F, 0xC0, coeff_div[match].Reg0x0F); //
        regmap_write(Everest.regmap, Everest_Reg0x11, coeff_div[match].Reg0x11);
        regmap_write(Everest.regmap, Everest_Reg0x21, coeff_div[match].Reg0x21);
        regmap_write(Everest.regmap, Everest_Reg0x22, coeff_div[match].Reg0x22);
        regmap_write(Everest.regmap, Everest_Reg0x26, coeff_div[match].Reg0x26); //
        regmap_write(Everest.regmap, Everest_Reg0x2F, coeff_div[match].Reg0x2F); //
        regmap_update_bits(Everest.regmap, Everest_Reg0x30, 0xC0, coeff_div[match].Reg0x30);
        regmap_write(Everest.regmap, Everest_Reg0x41, coeff_div[match].Reg0x41);
        regmap_write(Everest.regmap, Everest_Reg0x42, coeff_div[match].Reg0x42);
        regmap_write(Everest.regmap, Everest_Reg0x43, coeff_div[match].Reg0x43);
        regmap_update_bits(Everest.regmap, Everest_Reg0x44, 0xC0, coeff_div[match].Reg0x44);
        regmap_update_bits(Everest.regmap, Everest_Reg0xF0, 0x71, coeff_div[match].Reg0xF0);
    }
    return match;
}
#if 0
static void Everest_set_dai_fmt(uint8_t fmt)
{
    switch(fmt & SND_SOC_DAIFMT_MASTER_MASK)
    {
        case SND_SOC_DAIFMT_CBS_CFS:                    ///* SLAVE MODE */
            regmap_update_bits(Everest.regmap,ES8389_Reg0x01_CLKTRI_MSMode,0x01,0x00);//Reg0x01 B0 =0
            break;
        case SND_SOC_DAIFMT_CBM_CFM:                    ///* MASTER MODE */
            regmap_update_bits(Everest.regmap,ES8389_Reg0x01_CLKTRI_MSMode,0x01,0x01);//Reg0x01 B0 =1
            break;
        default:
            break;
    }
    
    switch(fmt & SND_SOC_DAIFMT_FORMAT_MASK)
    {
        case SND_SOC_DAIFMT_I2S:
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0x1C,0x00);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0x1C,0x00);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x0C_MSTFMT_LRCKDivideH,0xE0,0x00);
            break;                
        case SND_SOC_DAIFMT_LEFT_J:
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0x1C,0x04);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0x1C,0x04);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x0C_MSTFMT_LRCKDivideH,0xE0,0x40);
            break;
        case SND_SOC_DAIFMT_DSP_A:
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0x1C,0x08);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0x1C,0x08);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x0C_MSTFMT_LRCKDivideH,0xE0,0x80);
            break;
        case SND_SOC_DAIFMT_DSP_B:
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0x1C,0x18);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0x1C,0x18);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x0C_MSTFMT_LRCKDivideH,0xE0,0xA0);
            break;
        default:
            break;
    }
        /* clock inversion */
    switch (fmt & SND_SOC_DAIFMT_INV_MASK) {
        case SND_SOC_DAIFMT_NB_NF://NORMAL BCLK NORMAL LRCK
            regmap_update_bits(Everest.regmap,ES8389_Reg0x02_CLKInvert,0x01,0x00);//BCLK NOInvert
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0x10,0x00);//LRCK NOInvert
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0x10,0x00);//LRCK NOInvert
            break;
        case SND_SOC_DAIFMT_IB_IF://INV BCLK INV LRCK
            regmap_update_bits(Everest.regmap,ES8389_Reg0x02_CLKInvert,0x01,0x01);//BCLK Invert
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0x10,0x10);//LRCK Invert
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0x10,0x10);//LRCK Invert
            break;
        case SND_SOC_DAIFMT_IB_NF://INV BCLK NORMAL LRCK
            regmap_update_bits(Everest.regmap,ES8389_Reg0x02_CLKInvert,0x01,0x01);//BCLK Invert
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0x10,0x00);//LRCK NOInvert
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0x10,0x00);//LRCK NOInvert
            break;
        case SND_SOC_DAIFMT_NB_IF://NORMAL BCLK INV LRCK
            regmap_update_bits(Everest.regmap,ES8389_Reg0x02_CLKInvert,0x01,0x00);//BCLK NOInvert
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0x10,0x10);//LRCK Invert
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0x10,0x10);//LRCK Invert
            break;
        default:
            break;
        }            
}

static void Everest_pcm_hw_params(uint8_t params)
{
    
    switch (params_format(params)){
        case SNDRV_PCM_FORMAT_S16_LE:
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0xE0,0x60);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0xE0,0x60);
            break;
        case SNDRV_PCM_FORMAT_S20_LE:
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0xE0,0x20);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0xE0,0x20);
            break;
        case SNDRV_PCM_FORMAT_S24_LE:
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0xE0,0x00);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0xE0,0x00);
            break;
        case SNDRV_PCM_FORMAT_S32_LE:
            regmap_update_bits(Everest.regmap,ES8389_Reg0x20_ADCFMT_ADCMUTE,0xE0,0x80);
            regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0xE0,0x80);
            break;
        default:
            break;
    }
}
#endif

static void Everest_set_bias_on(void)
{
    regmap_write(Everest.regmap, Everest_Reg0x4D, 0x02);
    regmap_write(Everest.regmap, Everest_Reg0x69, 0x23);
    regmap_write(Everest.regmap, Everest_Reg0x61, 0xD9);
    regmap_write(Everest.regmap, Everest_Reg0x64, 0x8F);
    regmap_write(Everest.regmap, Everest_Reg0x10, 0xE4);
    regmap_write(Everest.regmap, Everest_Reg0x00, 0x01);
    regmap_write(Everest.regmap, Everest_Reg0x03, 0xC3);
    ussleep(45); //45MS
    //delay_ms(45);
    regmap_write(Everest.regmap, Everest_Reg0x4D, 0x00);
    regmap_write(Everest.regmap, 0x24, 0x6D);
    regmap_write(Everest.regmap, 0x25, 0x0D);
}
#if 0
static void Everest_set_bias_standby(void)
{
    regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0x03,0x03);//DAC MUTE
    regmap_write(Everest.regmap,Everest_Reg0x10,0xD4);    
    ussleep(70); //70MS
    //delay_ms(70);
    regmap_write(Everest.regmap,Everest_Reg0x61,0x59);    
    regmap_write(Everest.regmap,Everest_Reg0x64,0x00);    
    regmap_write(Everest.regmap,Everest_Reg0x03,0x00);    
    regmap_write(Everest.regmap,Everest_Reg0x00,0x7E); 
    regmap_update_bits(Everest.regmap,ES8389_Reg0x40_DACFMT_DACMUTE,0x03,0x00);
}


static void Everest_set_bias_off(void)
{
    regmap_write(Everest.regmap,Everest_Reg0x01,0x28); 
    regmap_write(Everest.regmap,Everest_Reg0x69,0x00); 
    regmap_write(Everest.regmap,Everest_Reg0x60,0x00); 
    regmap_write(Everest.regmap,Everest_Reg0x00,0x00); 
    regmap_write(Everest.regmap,Everest_Reg0x10,0xCC); 
    ussleep(500); //500MS
    regmap_write(Everest.regmap,Everest_Reg0x10,0x00); 
    regmap_write(Everest.regmap,Everest_Reg0x61,0x08); 
    regmap_write(Everest.regmap,Everest_Reg0xF3,0xC1); 
    regmap_write(Everest.regmap,Everest_Reg0xF2,0x00);         
}
#endif
void Everest_mute(uint8_t mute)
{
    regmap_update_bits(Everest.regmap, ES8389_Reg0x40_DACFMT_DACMUTE, 0x03, mute ? 0x03 : 0x00);
}

void hal_es8389_init(void)
{
    Everest_probe();
    ussleep(100);
    Everest_set_dai_sysclk(ES8389_RATIO_MCLK_LRCK, ES8389_FreqMCLK);
    Everest_set_bias_on();
}
#endif
